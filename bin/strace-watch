#!/bin/bash

CMD=$*
STRACE_LOG="$(mktemp)"
UNIQUE_FILES="$(mktemp)"
TRACE_CMD="strace -efile -o $STRACE_LOG $*"
FILENAME_RE='s#(execve|stat|getcwd|access|open|mkdir|chdir|rmdir|rename)\("([^"]*)".*#\2#'

$TRACE_CMD

while true; do
    sed -r $FILENAME_RE $STRACE_LOG | grep -F $(pwd) | sort -u | xargs ls -d 2>/dev/null > $UNIQUE_FILES
    inotifywait -qq \
        -e modify -e close_write -e attrib -e move \
        -e create -e delete -e delete_self \
        --fromfile <(cat $UNIQUE_FILES; cat $UNIQUE_FILES | xargs dirname | sort -u)
    NOTIFY_RESPONSE=$?
    if [ "$NOTIFY_RESPONSE" -eq "1" ]; then
        exit $NOTIFY_RESPONSE
    fi
    $TRACE_CMD
done
